<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapoarte - Metrorex</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="icon" type="image/png" href="https://www.metrorex.ro/images/logo.svg">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <div class="logo-icon"><span></span></div>
                <span class="logo-text">METROREX</span>
            </a>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="/">AcasƒÉ</a></li>
                    <li><a href="/comenzi.html">Comenzi</a></li>
                    <li><a href="/dashboard.html" class="active">Rapoarte</a></li>
                    <li><a href="https://www.metrorex.ro/titluri-de-calatorie-tarife">Tarife</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h1 class="page-title">Rapoarte »ôi Statistici</h1>
            
            <div id="alertContainer"></div>
            
            <div class="page-layout">
                <div class="main-column">
                    
                    <!-- Actions bar -->
                    <div class="form-section">
                        <div class="actions-row">
                            <span id="lastUpdate">Ultima actualizare: -</span>
                            <div class="actions-buttons">
                                <button class="btn btn-secondary" onclick="loadData()">ActualizeazƒÉ</button>
                                <button class="btn btn-primary" id="btnGenerateReport" onclick="generateReport()">GenereazƒÉ Raport PDF</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="form-section">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="statTotalComenzi">0</div>
                                <div class="stat-label">Total Comenzi</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statTotalVanzari">0.00</div>
                                <div class="stat-label">Total V√¢nzƒÉri (RON)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statTotalTVA">0.00</div>
                                <div class="stat-label">TVA Colectat (RON)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statMediaComanda">0.00</div>
                                <div class="stat-label">Media ComandƒÉ (RON)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statBilete">0</div>
                                <div class="stat-label">Bilete</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statAbonamente">0</div>
                                <div class="stat-label">Abonamente</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row 1 -->
                    <div class="charts-row">
                        <div class="chart-card">
                            <div class="chart-header"><h3 class="chart-title">Tipuri produse</h3></div>
                            <div class="chart-body">
                            <div class="chart-container">
                                <canvas id="chartBileteAbonamente"></canvas>
                            </div>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header"><h3 class="chart-title">Metode de platƒÉ</h3></div>
                            <div class="chart-body">
                            <div class="chart-container">
                                <canvas id="chartMetodePlata"></canvas>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row 2 -->
                    <div class="charts-row">
                        <div class="chart-card">
                            <div class="chart-header"><h3 class="chart-title">Top produse v√¢ndute</h3></div>
                            <div class="chart-body">
                            <div class="chart-container">
                                <canvas id="chartTopProduse"></canvas>
                            </div>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header"><h3 class="chart-title">Comenzi pe zile</h3></div>
                            <div class="chart-body">
                            <div class="chart-container">
                                <canvas id="chartComenziZile"></canvas>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart Full Width -->
                    <div class="chart-card full-width">
                        <div class="chart-header"><h3 class="chart-title">Venituri per produs (RON)</h3></div>
                        <div class="chart-body">
                        <div class="chart-container">
                            <canvas id="chartVenituriProduse"></canvas>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Tables Row -->
                    <div class="tables-row">
                        <div class="table-card">
                           <div class="chart-header"><h3 class="table-title">Top 5 produse</h3></div> 
                            <table class="data-table" id="tableTopProduse">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Produs</th>
                                        <th>Comenzi</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4">Se √ÆncarcƒÉ...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="table-card">
                            <div class="chart-header"><h3 class="table-title">Sumar financiar</h3></div>
                            <table class="data-table" id="tableFinanciar">
                                <thead>
                                    <tr>
                                        <th>Indicator</th>
                                        <th>Valoare</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="2">Se √ÆncarcƒÉ...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Contact sidebar -->
                <div class="contact-sidebar">
                    <div class="contact-item">
                        <span class="icon">üìû</span>
                        <div>
                            <a href="tel:+40219335">021.9335</a>
                            <span class="contact-hours">(L-D 6-23)</span>
                        </div>
                    </div>
                    <div class="contact-item">
                        <span class="icon">‚úâÔ∏è</span>
                        <a href="mailto:contact@metrorex.ro">contact@metrorex.ro</a>
                    </div>
                    <div class="contact-item">
                        <span class="icon">üìÖ</span>
                        Program transport cƒÉlƒÉtori: <br>Zilnic 05:00 - 23:00
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="https://card.metrorex.ro/#/faq">FAQS</a>
                    <a href="https://card.metrorex.ro/#/contact">Contact</a>
                    <a href="https://anpc.ro/">ANPC</a>
                </div>
                <div class="footer-social">
                     <a href="https://www.facebook.com/metrorexoficial.ro/"><img src="https://www.metrorex.ro/images/fb.svg" alt="Facebook"></a>
                    <a href="https://www.instagram.com/metrorex_sa/"><img src="https://www.metrorex.ro/images/ig.svg" alt="Instagram"></a>
                    <a href="https://www.linkedin.com/company/metrorex/"><img src="https://www.metrorex.ro/images/linkedin.svg" alt="LinkedIn"></a>
                </div>
                <div class="footer-logos">
                    <span class="payment-badge">MasterCard SecureCode</span>
                    <span class="payment-badge">Verified by VISA</span>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Raport Generat</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Raportul a fost generat cu succes!</p>
                <p id="modalStats"></p>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="downloadReport()">DescarcƒÉ PDF</button>
                    <button class="btn btn-secondary" onclick="closeModal()">√énchide</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ZILE = ['Luni', 'Mar»õi', 'Miercuri', 'Joi', 'Vineri', 'S√¢mbƒÉtƒÉ', 'DuminicƒÉ'];
        
        const NUME_PRODUSE = {
            'bilet_1_calatorii': 'Bilet 1 cal.',
            'bilet_2_calatorii': 'Bilet 2 cal.',
            'bilet_10_calatorii': 'Bilet 10 cal.',
            'bilet_19_calatorii_s': 'Bilet 19 cal. (stud.)',
            'abonament_24': 'Abon. 24h',
            'abonament_72': 'Abon. 72h',
            'abonament_saptamanal': 'Abon. sƒÉptƒÉm√¢nal',
            'abonament_lunar': 'Abon. lunar',
            'abonament_lunar_elev': 'Abon. lunar elevi',
            'abonament_6l': 'Abon. 6 luni',
            'abonament_anual': 'Abon. anual',
            'abonament_donatori': 'Abon. donatori'
        };
        
        let charts = {};
        let currentPdfFile = null;
        
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        async function loadData() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    updateStats(data.stats);
                    updateCharts(data.stats);
                    updateTables(data.stats);
                    
                    document.getElementById('lastUpdate').textContent = 
                        'Ultima actualizare: ' + new Date().toLocaleString('ro-RO');
                    
                    showAlert('Date actualizate cu succes!', 'success');
                } else {
                    showAlert('Eroare: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Eroare la √ÆncƒÉrcarea datelor: ' + error.message, 'error');
            }
        }
        
        function updateStats(stats) {
            document.getElementById('statTotalComenzi').textContent = stats.total_comenzi || 0;
            document.getElementById('statTotalVanzari').textContent = (stats.total_vanzari || 0).toFixed(2);
            document.getElementById('statTotalTVA').textContent = (stats.total_tva || 0).toFixed(2);
            document.getElementById('statMediaComanda').textContent = (stats.media_comanda || 0).toFixed(2);
            document.getElementById('statBilete').textContent = stats.bilete_vs_abonamente?.bilete || 0;
            document.getElementById('statAbonamente').textContent = stats.bilete_vs_abonamente?.abonamente || 0;
        }
        
        function updateCharts(stats) {
            // Chart 1: Bilete vs Abonamente (Doughnut)
            if (charts.bileteAbonamente) charts.bileteAbonamente.destroy();
            const bileteData = [
                stats.bilete_vs_abonamente?.bilete || 0, 
                stats.bilete_vs_abonamente?.abonamente || 0
            ];
            charts.bileteAbonamente = new Chart(document.getElementById('chartBileteAbonamente'), {
                type: 'doughnut',
                data: {
                    labels: ['Bilete', 'Abonamente'],
                    datasets: [{
                        data: bileteData,
                        backgroundColor: ['#4380bf', '#4300bf'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            // Chart 2: Metode de Plata (Bar)
            if (charts.metodePlata) charts.metodePlata.destroy();
            const metode = stats.metode_plata || {};
            const metodeLabels = Object.keys(metode).map(m => {
                return m === 'card' ? 'Card' : m === 'cash' ? 'Numerar' : 'Transfer';
            });
            charts.metodePlata = new Chart(document.getElementById('chartMetodePlata'), {
                type: 'bar',
                data: {
                    labels: metodeLabels,
                    datasets: [{
                        label: 'Comenzi',
                        data: Object.values(metode),
                        backgroundColor: ['#4380bf', '#4380bf', '#4380bf'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            // Chart 3: Top Produse (Horizontal Bar)
            if (charts.topProduse) charts.topProduse.destroy();
            const produse = stats.produse || {};
            const produseSorted = Object.entries(produse)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            charts.topProduse = new Chart(document.getElementById('chartTopProduse'), {
                type: 'bar',
                data: {
                    labels: produseSorted.map(p => NUME_PRODUSE[p[0]] || p[0]),
                    datasets: [{
                        label: 'Comenzi',
                        data: produseSorted.map(p => p[1]),
                        backgroundColor: '#4380bf',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
            
            // Chart 4: Comenzi pe Zile (Line)
            if (charts.comenziZile) charts.comenziZile.destroy();
            const comenziPerZi = stats.comenzi_per_zi || [0,0,0,0,0,0,0];
            charts.comenziZile = new Chart(document.getElementById('chartComenziZile'), {
                type: 'line',
                data: {
                    labels: ZILE,
                    datasets: [{
                        label: 'Comenzi',
                        data: comenziPerZi,
                        borderColor: '#4380bf',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            
            // Chart 5: Venituri per Produs (Bar)
            if (charts.venituriProduse) charts.venituriProduse.destroy();
            const vanzari = stats.vanzari_per_produs || {};
            const venituriSorted = Object.entries(vanzari)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            charts.venituriProduse = new Chart(document.getElementById('chartVenituriProduse'), {
                type: 'bar',
                data: {
                    labels: venituriSorted.map(p => NUME_PRODUSE[p[0]] || p[0]),
                    datasets: [{
                        label: 'Venituri (RON)',
                        data: venituriSorted.map(p => p[1].toFixed(2)),
                        backgroundColor: '#4380bf',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        
        function updateTables(stats) {
            // Table Top Produse
            const produse = stats.produse || {};
            const produseSorted = Object.entries(produse)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            let html1 = '';
            produseSorted.forEach((p, i) => {
                const pct = stats.total_comenzi > 0 ? (p[1] / stats.total_comenzi * 100).toFixed(1) : 0;
                html1 += `<tr>
                    <td>${i + 1}</td>
                    <td>${NUME_PRODUSE[p[0]] || p[0]}</td>
                    <td>${p[1]}</td>
                    <td>${pct}%</td>
                </tr>`;
            });
            document.querySelector('#tableTopProduse tbody').innerHTML = html1 || '<tr><td colspan="4">Nu sunt date</td></tr>';
            
            // Table Financiar
            const html2 = `
                <tr><td>Total V√¢nzƒÉri</td><td><strong>${(stats.total_vanzari || 0).toFixed(2)} RON</strong></td></tr>
                <tr><td>TVA Colectat (19%)</td><td>${(stats.total_tva || 0).toFixed(2)} RON</td></tr>
                <tr><td>V√¢nzƒÉri fƒÉrƒÉ TVA</td><td>${((stats.total_vanzari || 0) - (stats.total_tva || 0)).toFixed(2)} RON</td></tr>
                <tr><td>Media ComandƒÉ</td><td>${(stats.media_comanda || 0).toFixed(2)} RON</td></tr>
                <tr><td>ComandƒÉ Max</td><td>${(stats.max_comanda || 0).toFixed(2)} RON</td></tr>
                <tr><td>ComandƒÉ Min</td><td>${(stats.min_comanda || 0).toFixed(2)} RON</td></tr>
            `;
            document.querySelector('#tableFinanciar tbody').innerHTML = html2;
        }
        
        async function generateReport() {
            const btn = document.getElementById('btnGenerateReport');
            btn.disabled = true;
            btn.textContent = '‚è≥ Se genereazƒÉ...';
            
            try {
                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentPdfFile = data.pdf_file;
                    document.getElementById('modalMessage').textContent = data.message;
                    document.getElementById('modalStats').textContent = 
                        `Total comenzi analizate: ${data.stats.total_comenzi} | V√¢nzƒÉri: ${data.stats.total_vanzari.toFixed(2)} RON`;
                    document.getElementById('successModal').classList.add('active');
                } else {
                    showAlert('Eroare: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Eroare: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìÑ GenereazƒÉ Raport PDF';
            }
        }
        
        function downloadReport() {
            if (currentPdfFile) {
                window.location.href = '/download/' + currentPdfFile;
                closeModal();
            }
        }
        
        function closeModal() {
            document.getElementById('successModal').classList.remove('active');
        }
        
        // Close modal on overlay click
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>